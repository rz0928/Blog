---
title: 什么是伪共享?
date: 2024-10-30 16:34:24
tags:
  - cpu缓存
categories:	
  - 计算机基础
---

- CPU缓存架构
- 缓存一致性之MESI
- 伪共享问题

<!--more-->

# 1. Cpu缓存架构

计算机存储有着这么一条规律：越靠近CPU的空间访问速度越快，价格也越昂贵。依照这条规律，为了权衡速度与价格，CPU采用金字塔结构的多级缓存。

从[binarylei的博客](https://www.cnblogs.com/binarylei/p/12588928.html) 扒下来的图

![img](./什么是伪共享/1322310-20200328084130182-1706395900.png)

​	现代多核CPU缓存结构图如下：

[小林coding扒下来的图](https://xiaolincoding.com/os/1_hardware/cpu_mesi.html#cpu-cache-%E7%9A%84%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5)

<img src="./什么是伪共享/CPU-Cache.png" alt="img" style="zoom:50%;" />

L1和L2缓存是不同核心之间隔离开的，每个CPU核心都有自己L1和L2缓存。

Cpu缓存是由多个缓存行组成的，缓存行时CPU缓存变化的基本单位，cache line由`tag标记`和`data block`数据块组成。

- `data block`存放数据
- `tag`作用下面细说

# 2. 缓存一致性

## 2.1 mesi协议

CPU为了提升效率，在写数据时先考虑将数据写入cache line，让缓存需要被替换下去时才会将cache line数据更新到内存中。

单核环境下，这种先写缓存的方式没有什么问题，但是多核环境下同时操作数据就会导致线程安全问题，要保证不同核心缓存的一致性需要两点：

- **写传播**：某个CPU核心中的cache更新时，需要把这种状态传播给其他核心的cache
- **串行化**：写传播被每个CPU核心接受的顺序需要保持一致。例：写传播消息为 **i = 100**和 **i = 200**，每个核心都必须先接收到**i = 100** 然后再接受 **i = 200** 。





# 3. 伪共享问题
